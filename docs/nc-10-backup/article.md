# Система резервного копирования

![](https://habrastorage.org/webt/in/pk/uh/inpkuhyjnf8c-efshdvkj_edp7m.jpeg)

Резервное копирование - вторая основная задача, которую я хотел решить, [используя NAS](https://habr.com/post/359346/), после [системы управления репозиториями](https://habr.com/post/418883/).

Про данную тему написана масса статей и даже несколько книг, а в спорах о нём сломано много копий.
Остаётся разобраться в этой куче материала и построить систему, как требуется.

Итак...

<cut/>

Система резервного копирования определяется:

- Политикой резервного копирования. Политика задаёт основные цели и задачи резервного копирования, требования к нему, исходя из списка угроз для каждой резервируемой системы, а также обосновывает его необходимость.
- Регламентом резервного копирования, определяемого политикой. Регламент описывает алгоритмы резервного копирования и восстановления, ответственных за резервное копирование, условия хранения резервных копий и прочее.
- Инструментальной реализацией. Собственно, программное и аппаратное обеспечение.

Точки сопряжения системы с платформой:

- `tank0/apps/backup` - хранилище резервных копий.
- `tank1/apps/backup` - хранилище резервных копий.
- `https://backup.NAS.cloudns.cc` - WEB интерфейс системы.

Хранилища резервных копий являются **отдельными файловыми системами**.
Это нужно потому, что их опции могут сильно отличаться, как от нормальных файловых систем, так и между собой.
Например, могут быть включены дедупликация и сжатие средствами ФС.


## Политика резервного копирования

Цель резервного копирования: понижение затрат от незапланированного уничтожения данных в нештатных ситуациях.
Цель достигается путём дублирования ценных данных с рабочих машин в сторонние хранилища.


### Принципы резервного копирования

Стоит понимать, что хотя я описываю здесь частный случай резервного копирования, который заточен под нужды маленькой сети, принципы, наблюдения и закономерности везде общие.
В простых случаях некоторыми из них возможно пренебречь, но знать желательно.

Несколько принципов и рекомендаций, которые возможно применить в процессе разработки системы, возможно найти в статьях:

- ["Положение о системе резервного копирования"](http://securitypolicy.ru/%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B/%D0%B1%D0%B5%D0%BA%D0%B0%D0%BF).
- "Правило 3-2-1" [в блоге Veeam](https://habr.com/company/veeam/blog/188544/).
- [Набор правил и рекомендаций](https://habr.com/company/veeam/blog/176927/).
- У КРОКа, фактически, [описана часть политики](https://habr.com/company/croc/blog/230153/), выведенная на горьком опыте.
- [Очередные рекомендации](https://habr.com/company/veeam/blog/163405/).
- Вот [тут](http://securitypolicy.ru/%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B/%D0%B1%D0%B5%D0%BA%D0%B0%D0%BF) есть пример, как политики, так и регламента.
- Некоторые базовые вещи описаны в статье ["Минимизация рисков: как не потерять ваши данные"](https://1cloud.ru/blog/minimizazia-it-riskov).

Книги и работы:

- [W. Curtis Preston - "Backup & Recovery" - 2000](http://shop.oreilly.com/product/9780596102463.do).
- [Казаков В.Г. - Технологии и алгоритмы резервного копирования](http://www.ict.edu.ru/ft/005653/62330e1-st17.pdf).
- [Берман Дж. - Backup для "чайников" - 2014](http://2015.russianinternetforum.ru/upload/acronis-book.pdf).
- [Steven Nelson - Pro Data Backup and Recovery - 2011](https://www.amazon.com/Data-Backup-Recovery-Steven-Nelson/dp/1430226625).
- [Dorian Cougias - The Backup Book: Disaster Recovery from Desktop to Data Center, 3 edition - 2003](https://www.amazon.com/Backup-Book-Disaster-Recovery-Desktop/dp/0972903909).
- [Тут](https://solutionsreview.com/backup-disaster-recovery/top-books-on-backup-and-disaster-recovery-for-2017/) есть большой и относительно свежий (2017 года) список книг.

В большинстве книг описаны серьёзные инфраструктуры.
Следует читать и применять изложенное в них, если вам очень хочется посчитать и обосновать RTO, RPA, RPO. Впрочем, если вы это делаете, скорее всего вы и так занимаетесь резервированием крупных систем, а моя статья для вас бесполезна.


### Задачи резервного копирования

- Выделение целевых данных.
- Сохранение указанных данных для последующего восстановления.
- Восстановление сохранённых данных.
- Обеспечение устойчивости хранимых данных к изменению и уничтожению.
- Разграничение доступа к хранимым данным.
- Обеспечение контроля системы и процесса резервного копирования.


### Требования к системе

Далее в списке, как функциональные, так и нефункциональные требования вперемешку:

- Резервное копирование должно выполняться:
  * По расписанию.
  * По запросу.
  * При пропуске предыдущего.
- Должно быть обеспечено резервирование данных, как минимум 1 раз в сутки на глубину 1 месяц.
- Время восстановления данных не должно превышать 2 минуты на 1 GB (ограничение пропускной способности сети - 81 с. на 1 GB).
- Все каналы должны быть зашифрованы.
- Должна иметься возможность шифровать пользовательские резервные копии секретным ключом на машине пользователя, без возможности расшифровки на сервере. Это важно, потому что пользователи вовсе не обязаны доверять серверу.
- Неполное копирование не должно занимать много времени (используется Интернет), например более 30 минут.
- Должна быть потенциальная возможность репликации копий в облако (возможность гибко настроить репликацию для конкретного облачного хранилища) с шифрованием бэкапов.
- Должно быть простое централизованное управление бэкапами с интеграцией в web-интерфейс.
- Минимум доработок и сложной настройки на сервере.


### Состав резервируемых ресурсов

Достаточно типичный состав:

- Основная рабочая машина. Стационарный компьютер.
- Мобильная рабочая машина. Ноутбук.
- Роутер ЛВС.
- NAS. Да, конфигурация NAS тоже резервируется.


### Состав угроз

Требуется описать то, где от чего следует защищаться и каким образом.

<spoiler title="Для этого я составил небольшую таблицу угроз.">
| Ресурс                   | Угроза                                            | Решение
|--------------------------|---------------------------------------------------|--------------
| Основная рабочая машина  | Физическое разрушение данных                      | Резервирование данных и ключевых настроек
| Основная рабочая машина  | Частичное незаметное сразу повреждение данных     | Хранение более старых резервных копий в течение некоторого времени
| Основная рабочая машина  | Утеря доступа к данным                            | Хранение полного образа машины, либо **настроек, для быстрого разворота на другой машине**, также дублирование функций на мобильном ПК
| Основная рабочая машина  | Несанкционированный физический доступ к данным    | Шифрование данных и резервных копий, передача копий в шифрованном виде
| Основная рабочая машина  | Несанкционированный доступ путём нарушения ПО     | Резервирование контрольных сумм ПО и периодическая сверка, системы контроля (пока не реализую)
| Мобильная рабочая машина | Утеря машины вместе с данными                     | Шифрование данных, полное резервирование, либо резервирование ключевых настроек и данных
| Роутер ЛВС               | Разрушение конфигурации, либо устройства          | Резервирование конфигурации
| Роутер ЛВС               | Утеря контроля вследствие взлома                  | Резервирование конфигурации
| Роутер ЛВС               | Частичное незаметное повреждение данных           | Хранение контрольных сумм ПО и периодическая сверка
| NAS                      | Повреждение настроек служб                        | Локальное резервирование настроек
| NAS                      | Физическое разрушение данных                      | Репликация в облако
| NAS                      | Потеря доступа к системе и резервным копиям       | Репликация в облако
| NAS                      | Несанкционированный доступ к данным посторонних   |Хранение и репликация данных в шифрованном виде, обмен данными в шифрованном виде
| NAS                      | Несанкционированный доступ администратора к данным|Шифрование резервных копий на локальных ключах резервируемых машин

</spoiler>

Все основные угрозы мобильному компьютеру повторяют угрозы стационарному.
Планшетные компьютеры практически не отличаются от мобильного, с этой точки зрения.


### Дополнительные условия политики

- Должно проводиться регулярное тестирование восстановления.
- Процедура восстановления после сбоя должна быть задокументирована.
- Должны регламентироваться действия на случай вторичного сбоя: что делать, если после восстановления система не работоспособна, либо данные невозможно восстановить.
- Нужно тестировать, зависит ли процесс восстановления от специфичной аппаратуры
  (которая может выйти из строя в момент восстановления).
- Если кумулятивный объем инкрементальных резервных копий превосходит объем полной резервной копии, рационально сделать внеплановую полную резервную копию. Т.е., частота создания полных резервных копий, в таком случае должна быть повышена.
- При наличии полного резервного копирования системы, надо выполнять резервное копирование сразу после существенного обновления.


## Регламент резервного копирования

После разработки политики возможно приступать к разработке непосредственно регламента.


### Задачи регламента

- Определение процедуры резервирования данных.
- Определение процедуры восстановления данных.
- Определение процедуры проверки работоспособности системы.
- Условия хранения резервных копий и требования к носителям.
- Упорядочение работы.


### Пример регламента

Под спойлером вы можете увидеть, как выглядит регламент в крупной организации, на примере [взятого из открытых источников регламента Росреестра](http://www.just.kopr.ru/doc/just/Reglament_for_copy.docx).

<spoiler title="Регламент Росреестра.">
# РЕГЛАМЕНТ РЕЗЕРВНОГО КОПИРОВАНИЯ ДАННЫХ В ТЕРРИТОРИАЛЬНЫХ ПОДРАЗДЕЛЕНИЯХ РОСРЕЕСТРА


## Оглавление

1. Общие положения.
2. Порядок резервного копирования.
3. Контроль результатов.
4. Нормативно-правовое обеспечение.
5. Ротация носителей резервной копии.
6. Восстановление информации из резервной копии.
7. Приложение 1.
8. Приложение 2 Перечень лиц, ответственных за резервное копирование.


## **1**  Общие положения

Настоящий Регламент устанавливает основные требования к организации резервного копирования (восстановления) программ и данных, хранящихся в базах данных на серверах территориального органа Росреестра, а также к резервированию аппаратных средств.

Настоящий Регламент разработан с целью:

- определения категории информации, подлежащей обязательному резервному копированию;
- определения процедуры резервирования данных для последующего восстановления работоспособности информационных систем при полной или частичной потере информации, вызванной сбоями или отказами аппаратного или программного обеспечения, ошибками пользователей, чрезвычайными обстоятельствами (пожаром, стихийными бедствиями и т.д.);
- определения порядка восстановления информации в случае возникновения такой необходимости;
- упорядочения работы и определения ответственности должностных лиц, связанной с резервным копированием и восстановлением информации.

Под резервным копированием информации понимается создание полных копий производственных БД Управления, для быстрого восстановления работоспособности информационной системы ведения ЕГРП АИС «Юстиция», в случае возникновения аварийной ситуации, повлекшей за собой повреждение или утрату данных.

Резервному копированию подлежат все производственные БД всех территориальных отделов Управления.

Машинным носителям информации, содержащим резервную копию, присваивается гриф конфиденциальности по наивысшему грифу содержащихся на них сведений.

Резервные копии хранятся вне пределов серверного помещения, доступ к резервным копиям ограничен. Список лиц, имеющих доступ к данным, формируется на основании письменной Заявки руководителя подразделения информационных технологий (ИТ), согласованной с руководителем подразделения информационной безопасности (ИБ). Изменение прав доступа к резервируемым техническим средствам, массивам и носителям информации производится на основании Заявки руководителя подразделения ИТ, согласованной с руководителем подразделения ИБ. О выявленных попытках несанкционированного доступа к резервируемой информации и аппаратным средствам, а также иных нарушениях ИБ, произошедших в процессе резервного копирования, сообщается в подразделение ИБ служебной запиской в течение рабочего дня после обнаружения указанного события.


## **2** Порядок резервного копирования

Резервное копирование производится штатными средствами СУБД Oracle. Резервное копирование может производится:

- Вручную – оператор, ответственный за резервное копирование запускает процедуру экспорта Oracle (пример запуска процедуры в Приложении 1).
- Автоматически – запуск исполняемого файла, производящего вызов процедуры экспорта Oracle, производится операционной системой по расписанию автоматически.

Резервное копирование БД производится не реже 1 раза в сутки. Срок хранения резервной копии БД не менее 1 месяца.

Стратегия резервного копирования должна гарантировать синхронное восстановление данных, расположенных в разных схемах БД. Например, схема ХЭД (хранилище электронных документов), должна копироваться одновременно со схемой АИС Юстиция.

Материально-технические средства системы резервного копирования должны обеспечивать производительность, достаточную для сохранения информации, в установленные сроки и с заданной периодичностью. Лица, ответственные за организацию резервного копирования, ежедневно осуществляют контроль за наличием необходимого для резервного копирования объема дискового пространства.


## **3** Контроль результатов

Контроль результатов всех процедур резервного копирования осуществляется ответственными должностными лицами, указанными в Приложении 2, в срок до 10 часов рабочего дня, следующего за установленной датой выполнения этих процедур.

В случае обнаружения ошибки лицо, ответственное за контроль результатов, сообщает о ней в службу технической поддержки разработчика не позднее 11 часов текущего рабочего дня.


## **4** Нормативно-правовое обеспечение

Для организации процесса резервного копирования необходимо:

- Определить список лиц, ответственных за выполнение процесса резервного копирования и контроля его результатов (Приложение 2).
- Подготовить и утвердить график выполнения резервного копирования.
- Подготовить и утвердить внутренние распорядительные документы о назначении ответственных за резервное копирование данных.


## **5** Ротация носителей резервной копии

Система резервного копирования должна обеспечивать возможность периодической замены (выгрузки) резервных носителей без потерь информации на них, а также обеспечивать восстановление текущей информации автоматизированных систем в случае отказа любого из устройств резервного копирования. Все процедуры по загрузке, выгрузке носителей из системы резервного копирования, а также перемещение их в Службу безопасности и обратно, осуществляются администратором резервного копирования по запросу и в присутствии ответственного сотрудника Службы безопасности Заказчика (согласно Приложению №2).

В качестве новых носителей допускается повторно использовать те, у которых срок хранения содержащейся информации истек.

Конфиденциальная информация с носителей, которые перестают использоваться в системе резервного копирования, должна стираться с использованием программного обеспечения PGP.


## **6** Восстановление информации из резервной копии

В случае необходимости восстановление данных из резервных копий производится ответственным работником подразделения ИТ, указанным в Приложении N 2.

Восстановление данных из резервных копий происходит в случае ее исчезновения или нарушения вследствие несанкционированного доступа в систему, воздействия вирусов, программных ошибок, ошибок работников и аппаратных сбоев.

Восстановление системного программного обеспечения и программного обеспечения общего назначения производится с их носителей в соответствии с инструкциями производителя.

Восстановление специализированного программного обеспечения производится с дистрибутивных носителей или их резервных копий в соответствии с инструкциями по установке или восстановлению данного программного обеспечения.

Восстановление информации, не относящейся к постоянно изменяемым базам данных, производится с резервных носителей. При этом используется последняя копия информации.

При частичном нарушении или исчезновении записей баз данных восстановление производится с последней ненарушенной ежедневной копии. Полностью информация восстанавливается с последней копии.


## **7** Приложение 1

Пример запуска утилиты экспорта Oracle из командной строки:

exp userid=JUST\_USER/PASSWORD@SERVER owner=(JUST\_USER,HED\_USER) direct=Y consistent=Y statistics=NONE compress=N file=C:\BACKUP.DMP log=C:\BACKUP.LOG

где:

JUST\_USER/PASSWORD@SERVER _–_ имя\_владельца\_схемы/пароль@имя\_сервера;

owner=(JUST\_USER,HED\_USER) – перечень копируемых схем, в данном примере одновременно экспортируются схема АИС Юстиция и схема ХЭД;

file=C:\BACKUP.DMP _–_ путь и имя создаваемого файла экспорта;

log=C:\BACKUP.LOG _–_ путь и имя создаваемого файла лога экспорта.


## **8** Приложение 2. Перечень лиц, ответственных за резервное копирование

| **№ п/п** | **Выполняемая роль** | **ФИО ответственного сотрудника** |
| --- | --- | --- |
| 1 | Первоначальная настройка системы резервного копирования. |   |
| 2 | Внесение существенных изменений в настройку системы резервного копирования. |   |
| 3 | Анализ логов резервного копирования, отслеживание необходимости изменений настроек резервного копирования, обеспечение ротации носителей. |   |
| 4 | Ротация носителей, проверка корректности резервной копии, обеспечения хранения резервной копии вне офиса на случай катастрофы. |   |
</spoiler>

[Здесь](https://netolkoit.ru/reglament-rezervnogo-kopirovaniya-razbor-sostavlyayushhih/) вы найдёте ещё один пример с небольшим описанием.


### Процедура резервирования

Состав резервируемых данных:

- Рабочие машины:
  * Личные каталоги пользователей (`/home/*`). Пользователи явно могут выключать часть данных из процесса копирования.
  * Общие каталоги пользователей.
  * ПО не из репозиториев, по возможности (`/opt`).
  * Настройки узла (`/etc`).
  * Состав установленных пакетов узла.
  * Базы данных.
  * Заголовки шифрованных разделов.
  * Каталоги виртуальных машин.
- Роутеры:
  - Настройки роутера.
- NAS:
  * Личные каталоги пользователей. Пользователи явно могут выключать часть данных из процесса копирования.
  * Общие каталоги пользователей.
  * Настройки узла.
  * Состав установленных пакетов узла.
  * Базы данных.
  * Файлы описания Docker контейнеров.
  * Заголовки шифрованных разделов.
  * Полные резервные копии машин.
- Планшетные компьютеры:
  - Резервирование данных не требуется.

Способ резервирования:

- Каталоги рабочих машин резервируются через агент системы.
- Специфичные настройки резервируются через агент, с использованием команд ОС.
- Роутеры резервируются через https://wiki.mikrotik.com/wiki/Automated_Backups
- NAS резервируется через агент.

Частота резервирования:

- Полная резервная копия делается 1 раз в месяц для всех машин. Копия производится первого числа месяца.
  Хранится 3 месяца.
- Декрементальная резервная копия делается 1 раз в неделю в субботу.
  Хранится месяц.
- Инкрементальная резервная копия делается 1 раз в день.
  Хранится месяц.
- Перед обновлением системы создаётся инкрементальная резервная копия.
  Хранится месяц.
- В конце месяца производится репликация полных копий в облачное хранилище.
  В качестве хранилища используется [Storj](https://storj.io/).
  Копии хранятся минимум 6 месяцев, и удаляются по мере заполнения хранилища.


### Процедура восстановления

![](https://habrastorage.org/webt/qu/i3/il/qui3ilw9nczsm17-w7d1dwcalhy.jpeg)

- Производится имеющим доступ к СРК, по запросу.
- Выполняется штатными средствами ПО, которое осуществляет резервное копирование.


### Процедура проверки работоспособности

- Производится постоянный контроль журналов системы резервного копирования.
- Раз в месяц производится частичный контроль работоспособности из резервной копии.

Предлагается использовать для проверки работоспособности виртуальную машину, запущенную на стационарном компьютере.


### Условия хранения резервных копий и требования к носителям

- Резервные копии хранятся на работающей системе.
- С периодом в 1 месяц производится репликация резервных копий в облачное хранилище.
  Репликация производится в ночное время с целью понижения загруженности канала в процессе его использования.
- Носители зашифрованы. Полнодисковое шифрование обеспечивается поддерживающей системой.
- Резервные копии шифруются СРК.


## Системы резервного копирования

Пришло время рассмотреть программное обеспечение, которое может быть использовано для резервного копирования.


### Требования к ПО

- Проприетарные закрытые решения типа [Veeam](https://www.veeam.com/ru) может быть хороши и продуманы, но не рассматриваются, по условиям политики безопасности. А некоторые из подобных решений, такие как продукты Acronis, вообще никуда не годны, если [судить](http://www.softportal.com/response-1689-acronis-true-image-1.html) по [мнению](https://thegrumpyitguy.wordpress.com/2013/07/09/i-fucking-hate-acronis-just-as-much-as-backup-exec/) недовольных [пользователей](https://ru-sysadmins.livejournal.com/2040268.html).
- Возможность для пользователей исключать часть дерева каталогов из процесса резервирования.
- Возможность восстановления из резервной копии средствами ПО.


### Выбор ПО

Под спойлером ниже рассмотрены несколько возможных систем для резервного копирования.
Ещё больше вы можете найти [здесь](https://github.com/jturgasen/my-links#backups), и [здесь](https://tproger.ru/digest/sysadmin-compilation/#1).

<spoiler title="Несколько вариантов систем.">
### Решения на базе unix-утилит

[Решения на основе rsync, tar, rdiff-backup, etc.](http://www.mikerubel.org/computers/rsync_snapshots/) не рассматриваются
по причине большого количества работы, которую потребуется выполнить, и отсутствия необходимого WEB-интерфейса.


### [Bareos](https://www.bareos.org/en/)

[![](https://habrastorage.org/webt/kp/pa/7t/kppa7tts84fep2t5rfk52poagx4.png)](https://habrastorage.org/webt/kp/pa/7t/kppa7tts84fep2t5rfk52poagx4.png)

BareOS (Backup Archiving Recovery Open Sourced) - форк Bacula с 2010 года.

Плюсы:

- Стабильная отлаженная система.
- Поддерживает несколько типов агентов под разные ОС.
- Поддерживает различные типы бэкапа: инкрементальный, дифференциальный, полный.
- WEB-интерфейс очень развит и функционален.
- Гибкая конфигурация.
- Имеется FUSE драйвер, который показывает бэкапы.
- Есть обвязка для Python, позволяющая взаимодействовать с Director.
- Есть агенты для бэкапа специфичных приложений (например, СУБД).
- Все коммуникации между различными компонентами системы аутентифицируются.
- Поддержка большого количества систем хранения.

Минусы:

- Ориентация на ленточный бэкап.
- Многокомпонентная запутанная система.
- Сложная и запутанная конфигурация.
- Требует постоянной поддержки, в случае минимальных изменений.
- Документация обширная (500+ страниц), но несмотря на это, настройка под типовой вариант использования сложна и занимает много времени.


### [BackupPC](http://backuppc.sourceforge.net)

[![](https://habrastorage.org/webt/zi/dv/e4/zidve44-5zrteeqdkiosyigkvwu.png)](https://habrastorage.org/webt/zi/dv/e4/zidve44-5zrteeqdkiosyigkvwu.png)

Безагентная система резервного копирования.

Плюсы и возможности:

- Возможен бэкап без агентов.
- Полные и инкрементальные бэкапы.
- Есть WEB-интерфейс.
- Минимизирует количество дисковых операций.
- Дедупликация. Одинаковые файлы сохраняются однократно, даже если это файлы на разных машинах.
- Возможность сжатия данных.
- Не нужен клиент, могут использоваться SMB, rsync.
- Возможность восстановления файлов прямо через WEB-интерфейс.
- Возможно восстановить как конкретные файлы, так и скачать все файлы архивом.
- Гибкая конфигурация, как системная, так и отдельная для каждой машины.
- Возможность посылать уведомления.

Минусы:

- Реализован на Perl, требует установки CPAN.
- Безагентный бэкап менее гибок, чем бэкап через агента, хотя и более безопасен.
- Нельзя выбрать время начала копирования (компенсируется выбором периодов, когда делать копирование запрещено).


### [UrBackup](https://www.urbackup.org)

[![](https://habrastorage.org/webt/u1/lo/ed/u1loed_wq1-njxjlq1f7ths2kso.png)](https://habrastorage.org/webt/u1/lo/ed/u1loed_wq1-njxjlq1f7ths2kso.png)

Клиент-серверная система резервного копирования.

[Пример настройки](https://habr.com/post/262499/).

Плюсы и возможности:

- Простая настройка.
- Есть WEB-интерфейс.
- Полные и инкрементальные бэкапы.
- Файловые бэкапы и бэкапы разделов (в т.ч. инкрементальные).
- Клиенты для Windows, Linux, MacOS X.
- Быстрая дедупликация на клиенте: быстро вычисляются изменения в дереве, и передаются только новые файлы или сектора диска.
- Бэкап разделов при запущенной системе.
- Возможность бэкапа каталогов при изменении.
- Корректные бэкапы используемых приложениями файлов (например, баз Outlook, клиент знает о распространённых приложениях).
- Дедупликация. Одинаковые файлы сохраняются однократно, даже если это файлы на разных машинах.
- Настройки бэкапов (частоту, количество и т.п.) клиент может менять для себя.
- Простая настройка.
- Предупреждение клиента о том, что бэкап не был сделан.
- Возможно восстановить как конкретные файлы, так и скачать все файлы архивом.
- Возможность посылать уведомления.
- Безопасные и эффективные бэкапы через Internet.
- Метаданные файлов (например, время изменения) сохраняются.
- Поддержка квот на размер бэкапов.
- Простое восстановление бэкапа раздела (например, через подключенную USB флешку).
- Автоматическое обновление.

Минусы:

- Клиент под Windows, способный отслеживать изменения блоков, платный.
- Бэкап разделов работает только с NTFS.


### [Restic](https://restic.net/)

Инструмент для резервного копирования и восстановления с консольным интерфейсом.

Плюсы и возможности:

- Простая настройка.
- Использует шифрование для шифрования резервных копий.
- Дедупликация. Одинаковые файлы сохраняются однократно, даже если это файлы на разных машинах.
- Нет понятия полного/инкрементального бэкапа. Все они равноценные. Передаются только новые блоки.
- Все данные и метаданные защищены контрольными суммами. Возможность проверки корректности бэкапа.
- Сервера бэкапа нет.
- Имеется FUSE драйвер, который показывает бэкапы в виде иерархии host/дата.

Минусы:

- WEB-интерфейса нет.
- Требователен к RAM (~2.7GB на 1TB).
- Не сохраняет ACL и расширенные атрибуты.
- Медленное и требовательное к RAM удаление ненужных бэкапов.
- Удаление ненужных бэкапов блокирует работу (производить бэкап в это время невозможно).
- Ключи шифрования одни на все хосты (в общем случае любой хост может прочитать все бэкапы). Проблема может быть решена.
- Медленное восстановление с помощью стандартного интерфейса restic.


### [BorgBackup](https://www.borgbackup.org/)

[![](https://habrastorage.org/webt/a_/qp/rh/a_qprhceevkysy_nk_xg20os5x0.jpeg)](https://habrastorage.org/webt/a_/qp/rh/a_qprhceevkysy_nk_xg20os5x0.jpeg)

Дедуплицирующая программа для резервного копирования.

Плюсы и возможности:

- Серверной части нет.
- Эффективное использование дискового пространства для хранения резервных копий.
- Достаточно высокопроизводителен (основной код на Python, но критичные участки реализованы на C и оптимизированы).
- Шифрование.
- Сжатие: LZ4, zlib, LZMA.
- Имеется FUSE драйвер, который показывает бэкапы.
- Простая установка на различные платформы: Linux, macOS, BSD, etc.
- [Есть WEB-интерфейс, как отдельный проект](https://borgweb.readthedocs.io/en/latest/).
- Поддерживается большим сообществом разработчиков.

Минусы:

- WEB-интерфейс достаточно ограниченный.
- Нет прямой поддержки ОС Windows (только через Linux subsystem или cygwin).


### [Lsyncd](https://github.com/axkibe/lsyncd)

Демон, выполняющий резервирование изменяемых файлов через rsync.

Плюсы и возможности:

- Использует inotify или fsevents для наблюдения за каталогом. После истечения времени вызывает rsync для копирования изменений.
- Может использовать не только rsync.
- Реализован на Lua, конфиг процедурный тоже на Lua.
- Почти не снижает производительной локальной ФС.
- Гибко настраивается.

Минусы:

- Легковесная система. Не имеет WEB-интерфейса и централизованной настройки.


### [Box Backup](https://www.boxbackup.org/)

[![](https://habrastorage.org/webt/4e/o-/ta/4eo-taslxisuzzofmwhmmjtjxmk.png)](https://habrastorage.org/webt/4e/o-/ta/4eo-taslxisuzzofmwhmmjtjxmk.png)

Автоматическая онлайновая система с открытым исходным кодом.
[Описание на Хабр](https://habrahabr.ru/post/8156/).

Плюсы и возможности:

- Данные шифруются на клиенте и на сервере хранятся в зашифрованном виде и могут быть расшифрованы только клиентом, имеющим ключ.
- Трафик шифруется, используя TLS, авторизация как клиентов, так и сервера по SSL сертификатам.
- Возможен не только онлайновый, но и "традиционный" бэкап, при котором создаются снэпшоты.
- На сервер отправляются только изменённые файлы.
- Поведение, как у ленты: доступны и новые, и удалённые файлы.
- На сервере сохраняются только изменения файлов, а не полная копия.
- Используется сжатие.
- Может быть настроен оптимальный режим резервирования: для документов или для сервера.
- Возможность обеспечения избыточности без использования RAID.
- Поддержка \*nix-like систем, Windows native, Windows cygwin.
- Есть локальный GUI.

Минусы:

- Данные хранятся в виде файлов, имена которых являются UID. В случае утери ключа или повреждения системы, восстановить данные будет сложно.
- Отсутствует Web-интерфейс.

</spoiler>

Изо всех решений я выбрал [UrBackup](https://www.urbackup.org/download.html).
Далее, покажу вариант его настройки.


### Настройка UrBackup

Если файловая система под бэкапы ещё не создана, её надо создать:

```
# zfs create -o com.sun:auto-snapshot=false -p tank0/apps/backup
# zfs set compression=on tank0/apps/backup
```

Снэпшоты не требуются, а вот сжатие лучше включить, следуя [части руководства UrBackup про ZFS бэкэнд](https://www.urbackup.org/administration_manual.html#x1-10700011.6.4).

На своё усмотрение, при наличии достаточного количества памяти возможно подключить дедупликацию на данной файловой системе:

```
# zfs set dedup=on tank0/apps/backup
```

Теперь возможно поднять сервер UrBackup в контейнере:

```
# mkdir /tank0/docker/services/urbackup
# cd /tank0/docker/services/urbackup
# vim docker-compose.yml
# docker-compose up -d
```

Конфигурационный файл docker-compose приведён ниже.
Дальнейшая настройка производится из Web-интерфейса сервера и подробно описана в [Руководстве администратора](https://www.urbackup.org/administration_manual.html).

<spoiler title="docker-compose.yml">
```yaml
version: '2'

networks:
  docker0:
    external:
      name: docker0

services:
  urbackup:
    image: uroni/urbackup-server
    restart: always
    expose:
      - 55414
    volumes:
      - /tank0/apps/backup/urbackup/database:/var/urbackup
      - /tank0/apps/backup/urbackup/backups:/backups
      - /tank0/apps/backup/urbackup/log:/var/log
      - /etc/localtime:/etc/localtime:ro
    networks:
      - docker0
    environment:
    - VIRTUAL_HOST=backup.*
    - VIRTUAL_PORT=55414
    - VIRTUAL_PROTO=http
    - CERT_NAME=NAS.cloudns.cc
```
</spoiler>

Что требуется сделать в первую очередь:

1. Добавить администратора. Администратор должен иметь возможность зайти в случае обрыва связи между UrBackup и LDAP сервером.
2. Настроить интеграцию с LDAP.
3. Настроить почтовые оповещения.
4. Создать агентов и настроить их расписание. Делается в интерфейсе.

<spoiler title="LDAP">
С LDAP всё плохо. Он "поддерживается в экспериментальном режиме". Проще говоря, на данный момент он не работает.

По спойлером ниже приведена часть кода функции сервера, в которой формируется LDAP запрос.

<spoiler title="urbackupserver/serverinterface/helper.cpp">
```cpp
bool Helper::ldapLogin( const std::string &username, const std::string &password,
	std::string* ret_errmsg, std::string* rights, bool dry_login)
{
	if(url_fak==NULL)
	{
		return false;
	}

	ServerSettings settings(getDatabase());
	SLDAPSettings ldap_settings = settings.getLDAPSettings();

	if (!ldap_settings.login_enabled)
	{
		return false;
	}

	std::string sanitized_username = username;
	std::string to_sanitize = "\"[]:;|=+*?<>/\\,";
	for(size_t i=0;i<sanitized_username.size();++i)
	{
		if(std::find(to_sanitize.begin(), to_sanitize.end(), sanitized_username[i])!=to_sanitize.end())
		{
			sanitized_username[i]='_';
		}
	}

	std::string group_class_query = greplace("{USERNAME}", sanitized_username, (ldap_settings.group_class_query));

	std::string ldap_query = "ldap://" + ldap_settings.server_name +
		(ldap_settings.server_port>0?(":" + convert(ldap_settings.server_port)):"") +
		"/" + (group_class_query);

	std::string errmsg;
	std::vector<std::multimap<std::string, std::string> > data = url_fak->queryLDAP(ldap_query, ldap_settings.username_prefix+(username)+ldap_settings.username_suffix,
		(password), &errmsg);

	if(data.empty())
	{
		if(!errmsg.empty())
		{
			Server->Log("Login via LDAP failed: "+errmsg, LL_ERROR);

			if(ret_errmsg)
			{
				*ret_errmsg = errmsg;
			}
		}
		return false;
	}
	else
	{
		if(data.size()!=1)
		{
			Server->Log("LDAP query returned "+convert(data.size())+" items, but should return only one. Login failed.", LL_ERROR);
			if(ret_errmsg)
			{
				*ret_errmsg="LDAP query returned more than one result";
			}
			return false;
		}
```
</spoiler>

Как возможно увидеть, он формируется заменой `{USERNAME}` на имя пользователя и простой конкатенацией адреса сервера и непосредственно запроса в поле "Запрос группы и класса LDAP/AD".
Далее, выполняется GET запрос через libcurl.

Примеры LDAP запросов возможно посмотреть в [руководстве по Red Hat Directory Server](https://www.centos.org/docs/5/html/CDS/ag/8.0/LDAP_URLs-Examples_of_LDAP_URLs.html).

Сначала надо попробовать сформировать запрос и послать аналогично.
После нескольких попыток, это сделать удалось:

```
# curl  -u "cn=admin,dc=nas,dc=nas" 'ldap://172.21.0.1:389/ou=users,dc=nas,dc=nas?objectClass,memberOf?sub?(&(memberOf=cn=users_backup,ou=groups,dc=nas,dc=nas)(uid=artiom))'

Enter host password for user 'cn=admin,dc=nas,dc=nas': ***********

DN: cn=Artiom,ou=users,dc=nas,dc=nas
        objectClass: inetOrgPerson
        objectClass: posixAccount
        objectClass: top

        memberOf: cn=users_media,ou=groups,dc=nas,dc=nas
        memberOf: cn=users_backup,ou=groups,dc=nas,dc=nas
        memberOf: cn=users_cloud,ou=groups,dc=nas,dc=nas
        memberOf: cn=users_code,ou=groups,dc=nas,dc=nas
```

Таким образом, запрос в UrBackup будет таким:
```
ou=users,dc=nas,dc=nas?memberOf,objectClass?sub?(&(memberOf=cn=users_backup,ou=groups,dc=nas,dc=nas)(uid={USERNAME}))
```
</spoiler>

- Порт TCP 55415 - бэкап по Интернет.
- Порт TCP 55414 - Web-интерфейс по HTTP.
- Порт TCP 55413 - Web-интерфейс по FastCGI, что может быть полезно для интеграции с Web-сервером. Т.к. обратный прокси в NAS использует HTTP/HTTPS, этот вариант не требуется.
- Порт TCP 35621 - на этот порт клиент принимает запросы от сервера на получение файлов.
- Порт UDP 35622 - на этом порту слушает процесс ядра клиента. Сервер будет передавать на этот порт широковещательные запросы. Клиент отправит в ответ имя машины.
- Порт TCP 35623 - на этот порт ядро клиента принимает команды от процесса интерфейса клиента и от сервера.

Соответственно, порт 55415 нужно пробросить на роутере, а порты 35621, 35622, 35623 отобразить на соответствующие порты хоста и разрешить в брандмауэре.


### Установка агента

Теперь надо поставить агент и убедиться в том, что он появился в интерфейсе сервера.

Самый простой вариант, только консоль:
https://www.urbackup.org/download.html#linux_all_binary

```
# TF=`mktemp` && wget "https://hndl.urbackup.org/Client/2.3.4/UrBackup%20Client%20Linux%202.3.4.sh" -O $TF && sudo sh $TF; rm $TF
```

Вариант с GUI, требуется сборка:

https://www.urbackup.org/client_debian_ubuntu_install.html

Docker:

https://hub.docker.com/r/hejare/urbackup-client/


## Облачные сервисы для резервирования

Статья про резервное копирование получилась достаточно объёмной.
И поэтому о репликации в облако будет отдельная статья.
